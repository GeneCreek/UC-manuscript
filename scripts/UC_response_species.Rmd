---
title: "Responder and non-responder species"
author: "Marcel de Leeuw, (c) GeneCreek 2020"
date: "2/29/2020"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{"UC_reponse_species"}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include=F}
suppressPackageStartupMessages(library(tidyverse))
suppressPackageStartupMessages(library(Matrix))
suppressPackageStartupMessages(library(DESeq2))
suppressPackageStartupMessages(library(SpiecEasi))
suppressPackageStartupMessages(library(GGally))
suppressPackageStartupMessages(library(tidytree))
suppressPackageStartupMessages(library(phytools))
suppressPackageStartupMessages(library(ggtree))
```

## DESeq analysis

Our starting point here is a pre-computed Matrix containing relative abundances from selected patient samples from 4 studies which provide patient responder / non-responder status, as well as a tibble containing associated metadata.

```{r DESeq, echo=F}

load("../data/patients_species_comb.rda")
load("../data/patients_mt.rda")

# we restrain analysis to post FMT samples
postFMT_mt <- patients_mt %>%
    dplyr::filter(status=="post FMT") %>%
    dplyr::ungroup()

# we convert the relative abundances to faux counts and retain only taxa
# resolved at the species level
countData <- as.matrix(1+ceiling(1E8*patients_species_comb[
    grepl(" ", rownames(patients_species_comb)),
    postFMT_mt$sampleID]))

# building the DESeq analysis object
response <- factor(postFMT_mt$response, levels=c("NR", "RE"))
dds <- DESeqDataSetFromMatrix(countData, DataFrame(response), ~ response)

# running DESeq
dds <- DESeq(dds, test="Wald", fitType="local")

# postprocessing the results
res = results(dds, cooksCutoff = FALSE)
alpha = 0.0001
sigtab = res[which(res$padj < alpha), ]
postFMT_deseq <- tibble(taxon=rownames(sigtab), log2FC=sigtab$log2FoldChange) %>%
  dplyr::mutate(association=ifelse(log2FC<0, "NR", "RE"))

postFMT_deseq
```

## ecological network generation

Next, we run SPIEC-EASI to build an ecological network with the significant DESeq detected species. For the graph, we retain only species in interaction.

```{r SpiecEasi, echo=F}

# we restrain ananlysis to significant taxa and again, we use faux counts
postFMT_deseq_taxa <- as.matrix(t(1E8*patients_species_comb[
    postFMT_deseq$taxon,postFMT_mt$sampleID]))

# correlation is used for edge weights
postFMT_deseq_corr <- cor(postFMT_deseq_taxa)

# running SpiecEasi
postFMT_se <- spiec.easi(postFMT_deseq_taxa, method='mb', lambda.min.ratio=1e-2,
                          nlambda=20, pulsar.params=list(rep.num=100, ncores=4))

# we ask for connected vertices only with rmEmptyNodes
postFMT_ig2 <- adj2igraph(
  getRefit(postFMT_se)*postFMT_deseq_corr, rmEmptyNodes=T,
  vertex.attr=list(name=as.character(colnames(postFMT_deseq_taxa))))
postFMT_selection <- igraph::V(postFMT_ig2)$name
postFMT_vertex <- postFMT_deseq %>%
  dplyr::filter(taxon %in% postFMT_selection) %>%
  dplyr::arrange(factor(taxon, levels=postFMT_selection))

# we use association as color 
postFMT_ig2 <- igraph::set_vertex_attr(postFMT_ig2, "association", 
      value=postFMT_vertex$association)
palette = c(NR = "tomato", RE = "seagreen")

# negative correlation goes red
postFMT_edgecol = ifelse(igraph::E(postFMT_ig2)$weight>0, "grey80", "red")

GGally::ggnet2(postFMT_ig2, size=3, layout.exp=.2,
               label.size=3, color="association", palette=palette, label=F,
               edge.col=postFMT_edgecol, edge.size=1) +
  guides(colour=guide_legend(title=NULL, override.aes=list(size=4))) +
  theme(legend.position="bottom")

```

# cladogram

Below, we compute a cladogram from all of the significant DESeq detected species, using a pre-computed tibble containing taxonomic information for all species in the combined patients relative abundance Matrix loaded above.

```{r Cladogram, echo=F}

load("../data/patients_taxonomy.rda")

## as.phylo.formula from ape written by Julien Dutheil 
## (julien.duth...@univ-montp2.fr)
## modified by Liam Revell (liam.rev...@umb.edu)
## depends on ape & phytools
as.phylo.formula<-function (x, data = parent.frame(), ...){
    err<-"Formula must be of the kind \"~A1/A2/.../An\"."
    if(length(x)!=2)
        stop(err)
    if(x[[1]]!="~")
        stop(err)
    f<-x[[2]]
    taxo<-list()
    while(length(f)==3){
        if(f[[1]]!="/")
            stop(err)
        if(!is.factor(data[[deparse(f[[3]])]]))
            stop(paste("Variable",deparse(f[[3]]),
                "must be a factor."))
        taxo[[deparse(f[[3]])]]<-data[[deparse(f[[3]])]]
        if(length(f)>1)
            f<-f[[2]]
    }
    if(!is.factor(data[[deparse(f)]]))
        stop(paste("Variable",deparse(f),"must be a factor."))
    taxo[[deparse(f)]]<-data[[deparse(f)]]
    taxo.data<-as.data.frame(taxo)
    leaves.names<-as.character(taxo.data[,1])
    taxo.data[,1]<-1:nrow(taxo.data)
    f.rec<-function(subtaxo){
        u<-ncol(subtaxo)
        levels<-unique(subtaxo[,u])
        if(u==1){
            if(length(levels)!=nrow(subtaxo))
                warning("Error, leaves names are not unique.")
            return(as.character(subtaxo[,1]))
        }
        t<-character(length(levels))
        for(l in 1:length(levels)){
            x<-f.rec(subtaxo[subtaxo[,u]==levels[l],][1:(u-1)])
            t[l]<-paste("(",paste(x,collapse=","),")",sep="")
        }
        return(t)
    }
    string<-paste("(",paste(f.rec(taxo.data),collapse=","),
        ");",sep="")
    ## so that singles will be read without error
    phy<-read.newick(text=string)
    phy$edge.length<-rep(1,nrow(phy$edge))
    phy<-collapse.singles(phy)
    phy$tip.label<-leaves.names[as.numeric(phy$tip.label)]
    return(phy)
}

# we add taxonomic information to the DESeq detected taxa
post_FMT_deseq_taxo <- postFMT_deseq %>%
  dplyr::left_join(patients_taxonomy, by="taxon") %>%
  dplyr::mutate(label=taxon, taxon=factor(taxon))

# we create a tree object using the function above and add DESeq data to it
# since we will color edges according to fold change polarity, we substitute
# NA's with spaces
post_FMT_deseq_tree <- tidytree::as_tibble(as.phylo.formula(
  ~kingdom/phylum/class/order/family/genus/taxon, 
  data=post_FMT_deseq_taxo)) %>%
  dplyr::left_join(post_FMT_deseq_taxo, by="label") %>%
  dplyr::mutate(association=ifelse(is.na(association), " ", association))

ggtree(as.treedata(post_FMT_deseq_tree), 
       aes(color=association),
       layout="circular") +
  scale_color_manual(values=c("RE"="seagreen", "NR"="tomato", " "="grey70")) +
  guides(color=guide_legend(title=NULL, override.aes = list(size=2, alpha=c(0, 1, 1)))) +
  geom_tippoint(shape=16, size=2) +
  geom_hilight(node=172, fill="seagreen", alpha=0.15) +
  geom_strip('Acinetobacter junii', 'Campylobacter concisus', barsize=.5,
            fontsize=2.5, geom="label", fill="white", offset=.2,
            label="Proteobacteria", family="Open Sans", offset.text=-3, hjust=0.5) +
  geom_strip('Catenibacterium mitsuokai', 'Clostridium nexile', barsize=.5, 
             fontsize=2.5, geom="label", fill="white", offset=.2,
            label="Firmicutes", family="Open Sans", offset.text=-2, hjust=0.5) +
  geom_strip('Porphyromonas uenonis', 'Sediminibacterium goheungense', barsize=.5,
             fontsize=2.5, geom="label", fill="white", offset=.2,
            label="Bacteroidetes", family="Open Sans", offset.text=-2, hjust=0.5) +
  theme(legend.position=c(.15, 0.9), legend.background=element_blank(),
        legend.box.background=element_blank(), legend.key.height=unit(1.5, "mm"))

```



